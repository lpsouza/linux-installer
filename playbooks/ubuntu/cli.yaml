---
#
# This playbook install and customize a CLI environment for my needs.
#
- name: Install and configure CLI environment
  hosts: linux
  gather_facts: no
  become: yes

  tasks:
    - name: Install Github CLI
      block:
        - name: Install GitHub CLI
          apt:
            name: gh
            state: present
            update_cache: yes
      tags: github_cli

    - name: Install GitHub Copilot CLI
      block:
        - name: Check if GitHub Copilot CLI is already installed
          stat:
            path: "~/.local/bin/copilot"
          register: copilot_cli_installed
          become: no

        - name: Install GitHub Copilot CLI
          shell: |
            curl -fsSL https://gh.io/copilot-install | bash
          args:
            executable: /bin/bash
          when: not copilot_cli_installed.stat.exists
          become: no
      tags: copilot_cli

    - name: Install Node Version Manager (NVM)
      block:
        - name: Download and install NVM
          shell: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
          args:
            creates: "~/.nvm/nvm.sh"
          become: no

        - name: Load NVM and install latest Node.js LTS
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install --lts
          args:
            executable: /bin/bash
          become: no
      tags: nvm, gemini_cli, opencode_cli, devcontainer_cli

    - name: Install Google Gemini CLI
      block:
        - name: Check if Gemini CLI is already installed
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm list -g @google/gemini-cli
          args:
            executable: /bin/bash
          register: gemini_cli_check
          failed_when: false
          changed_when: false
          become: no

        - name: Install Gemini CLI
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm install -g @google/gemini-cli
          args:
            executable: /bin/bash
          when: gemini_cli_check.rc != 0
          become: no
      tags: gemini_cli

    - name: Install OpenCode CLI
      block:
        - name: Check if OpenCode CLI is already installed
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm list -g opencode-ai
          args:
            executable: /bin/bash
          register: opencode_cli_check
          failed_when: false
          changed_when: false
          become: no

        - name: Install OpenCode CLI
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm install -g opencode-ai@latest
          args:
            executable: /bin/bash
          when: opencode_cli_check.rc != 0
          become: no
      tags: opencode_cli

    - name: Install uv (Python package installer)
      block:
        - name: Install required system packages for uv
          apt:
            name:
              - curl
              - python3-pip
              - python3-venv
            state: present
            update_cache: yes

        - name: Download uv installer script
          get_url:
            url: https://astral.sh/uv/install.sh
            dest: /tmp/uv-install.sh
            mode: "0755"
          become: no

        - name: Install uv
          shell: |
            /tmp/uv-install.sh
          args:
            creates: "~/.local/bin/uv"
            executable: /bin/bash
          become: no
      tags: uv, speckit

    - name: Install GitHub Spec-Kit
      block:
        - name: Install specify-cli using uv tool
          shell: |
            export PATH="$HOME/.local/bin:$PATH"
            uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
          args:
            executable: /bin/bash
            creates: "~/.local/bin/specify"
          become: no
      tags: speckit

    - name: Install Dev Container CLI
      block:
        - name: Check if Dev Container CLI is already installed
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm list -g @devcontainers/cli
          args:
            executable: /bin/bash
          register: devcontainer_cli_check
          failed_when: false
          changed_when: false
          become: no

        - name: Install Dev Container CLI
          shell: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            npm install -g @devcontainers/cli
          args:
            executable: /bin/bash
          when: devcontainer_cli_check.rc != 0
          become: no
      tags: devcontainer_cli

    - name: Install 1password CLI
      block:
        - name: Check if 1Password CLI is already installed
          stat:
            path: "/usr/bin/op"
          register: onepassword_cli_installed
          become: no

        - name: Download 1Password key
          get_url:
            url: https://downloads.1password.com/linux/keys/1password.asc
            dest: /tmp/1password.asc
            mode: 0755
          when: not onepassword_cli_installed.stat.exists

        - name: Add 1Password keyring
          command: gpg --batch --yes --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg /tmp/1password.asc
          changed_when: false
          when: not onepassword_cli_installed.stat.exists

        - name: Get dpkg architecture
          command: "dpkg --print-architecture"
          register: dpkg_arch
          changed_when: false
          failed_when: false
          when: not onepassword_cli_installed.stat.exists

        - name: Add 1Password repository
          apt_repository:
            repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/{{ dpkg_arch.stdout }} stable main"
            state: present
            filename: 1password
          when: not onepassword_cli_installed.stat.exists

        - name: Install 1Password CLI
          apt:
            name: 1password-cli
            state: present
            update_cache: true
          when: not onepassword_cli_installed.stat.exists
      tags: onepassword_cli
