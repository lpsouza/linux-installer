---
#
# This playbook installs and configures the initial setup for any Ubuntu machine.
#
- name: Install and configure initial setup
  hosts: all
  gather_facts: no
  become: yes
  tasks:
    - name: Update and upgrade apt packages
      apt:
        update_cache: yes
        upgrade: yes

    - name: Install essential packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - apt-transport-https
        - apt-utils
        - asciinema
        - build-essential
        - ca-certificates
        - coreutils
        - curl
        - fontconfig
        - fuse
        - git
        - htop
        - jq
        - lsb-release
        - mc
        - ncdu
        - net-tools
        - pandoc
        - software-properties-common
        - stow
        - tmux
        - unzip
        - wget
        - whois
        - zip

    - name: Install default editor
      vars:
        NEOVIM_VERSION: "0.10.4"
      block:
        - name: Download Neovim appimage
          get_url:
            url: "https://github.com/neovim/neovim/releases/download/v{{ NEOVIM_VERSION }}/nvim-linux-x86_64.appimage"
            dest: /usr/local/bin/nvim
            mode: 0755

        - name: Create alias for Neovim in shell configuration files
          blockinfile:
            path: "{{ item }}"
            block: |
              alias vim='nvim'
              alias vi='nvim'
            mode: 0644
            create: yes
          with_items:
            - ~/.bashrc
            - ~/.zshrc
          become: false

    - name: Install NerdFonts
      block:
        - name: Check if is already installed
          stat:
            path: "~/.fonts/CascadiaCode"
          register: caskaydia_cove_nerd_font
          become: no

        - name: Download NerdFonts
          get_url:
            url: "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/CascadiaCode.zip"
            dest: "/tmp/CascadiaCode.zip"
            mode: 0644
          when: not caskaydia_cove_nerd_font.stat.exists
          become: no

        - name: Create local .fonts directory
          file:
            path: "~/.fonts/CascadiaCode"
            state: directory
            mode: 0755
          when: not caskaydia_cove_nerd_font.stat.exists
          become: no

        - name: Unzip NerdFonts
          unarchive:
            src: "/tmp/CascadiaCode.zip"
            dest: "~/.fonts/CascadiaCode"
            mode: 0644
          when: not caskaydia_cove_nerd_font.stat.exists
          become: no
