---
- name: Install gh
  hosts: localhost
  remote_user: lpsouza
  become: true
  become_user: root
  become_method: sudo
  gather_facts: false

  vars:
    gh_version: "2.29.0"

  tasks:
    - name: Check if gh is already installed
      shell: dpkg-query -W -f='${Status}' gh || echo "not installed"
      register: gh_package_status
      changed_when: false
      failed_when: gh_package_status.rc != 0

    - name: Download gh
      get_url:
        url: https://github.com/cli/cli/releases/download/v{{ gh_version }}/gh_{{ gh_version }}_linux_amd64.deb
        dest: /tmp/gh_{{ gh_version }}_linux_amd64.deb
      when: "'not installed' in gh_package_status.stdout"

    - name: Install gh
      apt:
        deb: /tmp/gh_{{ gh_version }}_linux_amd64.deb
        state: present
      when: "'not installed' in gh_package_status.stdout"
